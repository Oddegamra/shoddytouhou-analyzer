# -*- coding: utf-8 -*-

TYPECHART_1_5 = """Normal 	― 	― 	― 	― 	― 	― 	― 	― 	― 	― 	― 	― 	△ 	ｘ 	― 	― 	△
Fire 	― 	△ 	△ 	― 	◎ 	◎ 	― 	― 	― 	― 	― 	― 	△ 	― 	△ 	― 	◎
Water 	― 	◎ 	△ 	― 	△ 	― 	― 	― 	◎ 	― 	― 	― 	― 	― 	△ 	― 	―
Electric 	― 	― 	◎ 	△ 	△ 	― 	― 	― 	ｘ 	◎ 	― 	― 	― 	― 	△ 	― 	―
Grass 	― 	△ 	◎ 	― 	△ 	― 	― 	△ 	◎ 	△ 	― 	△ 	◎ 	― 	△ 	― 	―
Ice 	― 	△ 	△ 	― 	◎ 	△ 	― 	― 	― 	◎ 	― 	◎ 	― 	― 	◎ 	― 	△
Fighting 	◎ 	― 	― 	― 	― 	◎ 	― 	△ 	― 	△ 	△ 	△ 	◎ 	ｘ 	― 	◎ 	―
Poison 	― 	― 	― 	― 	◎ 	― 	― 	△ 	△ 	― 	― 	― 	△ 	△ 	― 	― 	△
Ground 	― 	◎ 	― 	◎ 	△ 	△ 	― 	◎ 	― 	ｘ 	― 	△ 	― 	― 	― 	― 	◎
Flying 	― 	― 	― 	△ 	◎ 	― 	◎ 	― 	― 	― 	― 	◎ 	― 	― 	― 	― 	△
Psychic 	― 	― 	― 	― 	― 	― 	◎ 	◎ 	― 	― 	△ 	― 	― 	― 	― 	△ 	―
Bug 	― 	― 	― 	― 	◎ 	― 	△ 	△ 	― 	△ 	◎ 	― 	― 	△ 	― 	◎ 	△
Rock 	― 	◎ 	― 	― 	― 	◎ 	△ 	― 	△ 	◎ 	― 	◎ 	― 	― 	― 	― 	△
Ghost 	ｘ 	― 	― 	― 	― 	― 	― 	― 	― 	― 	◎ 	― 	― 	◎ 	― 	△ 	―
Dragon 	― 	― 	― 	― 	― 	△ 	― 	― 	― 	― 	― 	― 	― 	― 	◎ 	― 	―
Dark 	― 	― 	― 	― 	― 	― 	△ 	― 	― 	― 	◎ 	― 	― 	◎ 	― 	△ 	△
Steel 	― 	△ 	△ 	― 	― 	◎ 	― 	― 	― 	― 	― 	― 	◎ 	― 	― 	◎ 	△"""

TYPECHART_1_8 = """Dream 	△ 	― 	△ 	― 	― 	◎ 	△ 	― 	― 	― 	― 	― 	― 	― 	△ 	◎ 	―
Ghost 	― 	◎ 	― 	△ 	― 	― 	ｘ 	― 	― 	― 	― 	― 	― 	― 	◎ 	△ 	ｘ
Flying 	― 	― 	― 	◎ 	― 	△ 	― 	― 	― 	― 	△ 	◎ 	― 	― 	― 	― 	―
Beast 	― 	◎ 	△ 	― 	― 	― 	― 	― 	― 	― 	― 	△ 	― 	◎ 	― 	― 	―
Miasma 	― 	△ 	― 	― 	△ 	ｘ 	― 	△ 	― 	◎ 	― 	◎ 	― 	― 	△ 	― 	―
Steel 	― 	― 	◎ 	― 	― 	△ 	◎ 	― 	△ 	△ 	― 	― 	◎ 	― 	― 	― 	―
Dark 	◎ 	ｘ 	― 	― 	― 	― 	△ 	― 	― 	― 	― 	― 	― 	― 	◎ 	△ 	―
Earth 	― 	― 	ｘ 	△ 	◎ 	◎ 	― 	― 	◎ 	― 	◎ 	△ 	― 	― 	― 	― 	―
Fire 	― 	― 	― 	◎ 	― 	◎ 	― 	△ 	△ 	△ 	― 	◎ 	◎ 	△ 	― 	― 	―
Water 	― 	― 	― 	◎ 	― 	― 	― 	◎ 	◎ 	△ 	― 	△ 	― 	△ 	― 	― 	―
Wind 	― 	― 	◎ 	― 	― 	― 	― 	ｘ 	― 	◎ 	△ 	△ 	― 	△ 	― 	― 	―
Nature 	― 	― 	△ 	― 	△ 	― 	― 	◎ 	△ 	◎ 	― 	△ 	― 	― 	― 	― 	―
Ice 	― 	― 	◎ 	― 	― 	― 	― 	― 	― 	△ 	― 	◎ 	△ 	― 	― 	― 	―
Faith 	― 	― 	― 	― 	△ 	― 	◎ 	― 	― 	― 	― 	― 	― 	― 	△ 	◎ 	―
Reason 	◎ 	△ 	― 	― 	◎ 	△ 	― 	― 	― 	― 	― 	― 	― 	◎ 	― 	△ 	―
Heart 	△ 	― 	― 	― 	△ 	― 	◎ 	― 	― 	― 	― 	― 	― 	△ 	◎ 	△ 	―
Illusion 	△ 	ｘ 	― 	― 	― 	― 	△ 	― 	― 	― 	― 	― 	― 	― 	― 	― 	―"""


class _TypeChart(object):
	def __init__(self, chart_data):
		"""@param chart_data: Textual representation of type relations (see above) """

		# Create types and their names
		self.types = self._create_types(chart_data)

	def _create_types(self, chart):
		names = []
		matrix = []
		for line in chart.split("\n"):
			parts = line.split("\t")
			name = parts[0].strip()
			names.append(name)
			matrix.append([self._string_to_multiplier(char) for char in parts[1:]])

		types = []
		for i, name in enumerate(names):
			row = [line[i] for line in matrix]
			types.append(Type(name, row, self))

		return types

	def _string_to_multiplier(self, char):
		char = char.strip()
		if char == "◎":
			return 2.0
		elif char == "△":
			return 0.5
		elif char == "ｘ":
			return 0.0
		else:
			return 1.0

	def get_type(self, name):
		for type in self.types:
			if type.get_name().lower() == name.lower():
				return type

		raise Exception("Type {0} doesn't exist.".format(name))

	def get_dual_type(self, names):
		if isinstance(names, str):
			names = [name.strip() for name in names.split("/")]

		types = [self.get_type(name) for name in names]
		return DualType(types)

	def get_types(self):
		return self.types


class Type(object):
	def __init__(self, name, multipliers, type_chart):
		self.name = name
		self.types = [ self ]
		self.def_multipliers = None
		self.off_multipliers = None
		self.type_chart = type_chart
		self._multipliers = multipliers

	def get_name(self):
		""" Name of type """
		return self.name

	def get_types(self):
		""" Returns a list of types this type is made of. """
		return self.types

	def get_def_multipliers(self):
		""" Multipliers against types when this type is defending """
		if self.def_multipliers:
			return self.def_multipliers
		else:
			self.def_multipliers = {}
			for i, strength in enumerate(self._multipliers):
				other_type = self.type_chart.get_types()[i]
				self.def_multipliers[other_type] = strength

			return self.def_multipliers

	def get_off_multipliers(self):
		""" Multipliers against types when this type is attacking """
		if self.off_multipliers:
			return self.off_multipliers
		else:
			self.off_multipliers = {}
			for type in self.get_def_multipliers().keys():
				self.off_multipliers[type] = type.get_def_multipliers()[self]

			return self.off_multipliers

	def __eq__(self, other):
		if isinstance(other, Type):
			return self.name == other.name
		else:
			return False

	def __str__(self):
		return self.get_name()

	def __repr__(self):
		return "Type {0}".format(self.get_name())

	def __len__(self):
		return 1

	def __hash__(self):
		return hash(self.name)

class DualType(Type):
	def __init__(self, types):
		self.types = types

	def get_name(self):
		return "/".join([type.get_name() for type in self.types])

	def get_def_multipliers(self):

		def_multipliers = {}
		for type in TypeChart.get_types():
			def_multipliers[type] = 1.0

		for other_type in self.types:
			for type, multiplier in other_type.get_def_multipliers().items():
				def_multipliers[type] *= multiplier

		return def_multipliers

	def get_off_multipliers(self):
		off_multipliers = {}
		for other_type in self.types:
			for type, multiplier in other_type.get_off_multipliers().items():
				if type in off_multipliers:
					off_multipliers[type] = max(multiplier, off_multipliers[type])
				else:
					off_multipliers[type] = multiplier

		return off_multipliers

	def __eq__(self, other):
		if isinstance(other, DualType) and len(other.types) == len(self.types):
			for type in other.types:
				if type not in self.types:
					return False

			return True
		else:
			return False

	def __len__(self):
		return len(self.types)

TypeChart = _TypeChart(TYPECHART_1_8)
